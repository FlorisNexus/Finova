name: CD - Publish NuGet Packages

on:
  release:
    types: [published]
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      version_override:
        description: 'Version override (leave empty for auto-detection)'
        required: false
        type: string

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Determine Version
      id: get_version
      run: |
        # Check if version override is provided (workflow_dispatch)
        if [ -n "${{ inputs.version_override }}" ]; then
          VERSION="${{ inputs.version_override }}"
          echo "Using override version: $VERSION"
        # Release event - use tag
        elif [ "${{ github.event_name }}" == "release" ]; then
          VERSION=${GITHUB_REF_NAME#v}
          echo "Release version from tag: $VERSION"
        # Develop branch - use alpha versioning
        elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          LATEST_TAG=${LATEST_TAG#v}

          # Count commits since last tag
          COMMIT_COUNT=$(git rev-list --count HEAD ^$(git describe --tags --abbrev=0 2>/dev/null || echo HEAD~100))

          # Get short commit hash
          COMMIT_HASH=$(git rev-parse --short HEAD)

          # Parse version components (major.minor.patch)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_TAG"
          PATCH=${PATCH:-0}

          # Increment patch for alpha
          NEXT_PATCH=$((PATCH + 1))

          # Create alpha version: X.Y.Z-alpha.{commit_count}+{hash}
          VERSION="${MAJOR}.${MINOR}.${NEXT_PATCH}-alpha.${COMMIT_COUNT}"
          echo "Alpha version for develop: $VERSION"
        else
          # Fallback for manual dispatch without override
          VERSION="0.0.1-dev"
          echo "Fallback version: $VERSION"
        fi

        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Final Version: $VERSION"

        # Determine if this is a prerelease
        if [[ "$VERSION" == *"-"* ]]; then
          echo "IS_PRERELEASE=true" >> $GITHUB_OUTPUT
        else
          echo "IS_PRERELEASE=false" >> $GITHUB_OUTPUT
        fi

    - name: Restore
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore -p:Version=${{ steps.get_version.outputs.VERSION }}

    - name: Test
      run: dotnet test --configuration Release --no-build

    - name: Pack All Libraries
      run: |
        dotnet pack Finova.sln \
          --configuration Release \
          --no-build \
          --output ./nupkgs \
          -p:PackageVersion=${{ steps.get_version.outputs.VERSION }} \
          -p:Version=${{ steps.get_version.outputs.VERSION }}

    - name: Publish to NuGet.org
      run: |
        dotnet nuget push "./nupkgs/*.nupkg" \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate

    - name: Publish to GitHub Packages
      run: |
        dotnet nuget push "./nupkgs/*.nupkg" \
          --api-key ${{ secrets.GITHUB_TOKEN }} \
          --source https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json \
          --skip-duplicate

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: nuget-packages
        path: ./nupkgs/*.nupkg
        retention-days: 7
